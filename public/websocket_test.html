<!DOCTYPE html>
<html>
<head>
    <title>React WebSocket Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        #log { background: #f0f0f0; padding: 10px; height: 400px; overflow-y: scroll; margin-top: 10px; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
    </style>
</head>
<body>
    <h1>WebSocket Test from React Server</h1>
    <p>Testing WebSocket connection from React development server context</p>
    <p><strong>Current URL:</strong> <span id="currentUrl"></span></p>
    
    <button onclick="testConnection()">Test WebSocket Connection</button>
    <button onclick="testIP()">Test with 127.0.0.1</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div id="status">Ready to test...</div>
    <div id="log"></div>

    <script>
        document.getElementById('currentUrl').textContent = window.location.href;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        function testConnection() {
            testWebSocket('ws://localhost:8080');
        }

        function testIP() {
            testWebSocket('ws://127.0.0.1:8080');
        }

        function testWebSocket(url) {
            const status = document.getElementById('status');
            status.innerHTML = `Testing connection to ${url}...`;
            
            log(`üîÑ Testing WebSocket connection to: ${url}`, 'info');
            log('üîç Current location: ' + window.location.href, 'info');
            log('üîç Location protocol: ' + window.location.protocol, 'info');
            
            try {
                const ws = new WebSocket(url);
                
                log('‚úÖ WebSocket object created successfully', 'success');
                log('üîç Initial readyState: ' + ws.readyState, 'info');
                
                let messageReceived = false;
                let connectionEstablished = false;
                
                ws.onopen = function(event) {
                    connectionEstablished = true;
                    log('üéâ Connection opened successfully!', 'success');
                    log('üîç Final readyState: ' + ws.readyState, 'success');
                    status.innerHTML = '‚úÖ Connected successfully!';
                    
                    // Send test message
                    const testMessage = {
                        type: 'start_pitch_session',
                        customer: { name: 'React Server Test' },
                        timestamp: Date.now()
                    };
                    
                    ws.send(JSON.stringify(testMessage));
                    log('üì§ Sent test message', 'info');
                };
                
                ws.onmessage = function(event) {
                    messageReceived = true;
                    try {
                        const data = JSON.parse(event.data);
                        log('üì® Received: ' + data.type, 'success');
                        
                        if (data.type === 'textFeedback') {
                            log('üéØ AI Response received successfully!', 'success');
                            setTimeout(() => {
                                ws.close();
                                status.innerHTML = '‚úÖ Test completed successfully!';
                            }, 1000);
                        }
                        
                    } catch (error) {
                        log('‚ùå Error parsing message: ' + error.message, 'error');
                    }
                };
                
                ws.onclose = function(event) {
                    log(`üîå Connection closed. Code: ${event.code}, Reason: ${event.reason || 'Normal closure'}`, 'info');
                    
                    if (messageReceived) {
                        status.innerHTML = '‚úÖ Test completed - WebSocket working perfectly!';
                        log('üéâ SUCCESS: WebSocket connection working from React server!', 'success');
                        log(`üìã Connection closed normally after successful communication (code ${event.code})`, 'info');
                    } else {
                        // Only treat as failure if connection never established or critical error
                        if (event.code === 1006 && !connectionEstablished) {
                            status.innerHTML = `‚ùå Connection failed - Server unreachable`;
                            log('‚ùå FAILED: Could not connect to WebSocket server', 'error');
                        } else if (event.code === 1002 || event.code === 1003) {
                            status.innerHTML = `‚ùå Connection failed (Protocol error: ${event.code})`;
                            log('‚ùå FAILED: WebSocket protocol error', 'error');
                        } else {
                            status.innerHTML = '‚ö†Ô∏è Connection closed before message test';
                            log('‚ö†Ô∏è Connection closed before message exchange completed', 'warn');
                        }
                    }
                };
                
                ws.onerror = function(error) {
                    log('‚ùå WebSocket error occurred', 'error');
                    log('üîç Error details: ' + JSON.stringify(error), 'error');
                    status.innerHTML = '‚ùå Connection error';
                };
                
                // Timeout check
                setTimeout(() => {
                    if (ws.readyState === WebSocket.CONNECTING) {
                        log('‚è∞ Connection timeout after 5 seconds', 'error');
                        ws.close();
                        status.innerHTML = '‚ùå Connection timeout';
                    }
                }, 5000);
                
            } catch (error) {
                log('üí• Exception creating WebSocket: ' + error.message, 'error');
                status.innerHTML = '‚ùå WebSocket creation failed';
            }
        }

        // Auto-log environment info
        window.onload = function() {
            log('üåê Page loaded from React development server', 'info');
            log('üìç Location: ' + window.location.href, 'info');
            log('üîí Protocol: ' + window.location.protocol, 'info');
            log('üè† Host: ' + window.location.host, 'info');
        };
    </script>
</body>
</html>
